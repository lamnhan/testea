<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Rewiring</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css"
    />

    <link rel="stylesheet" href="https://lamnhan.com/testea/assets/main.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="https://lamnhan.com/testea"
        >@lamnhan/testea documentation</a
      >
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item"></li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="https://lamnhan.com">Homepage</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/lamnhan/testea"
              >Github</a
            >
          </li>
        </ul>
      </div>
    </nav>

    <div class="container-fluid main">
      <div class="row">
        <aside class="col-3 menu">
          <div><strong>Table of content</strong></div>
          <ul>
            <li>
              <a href="https://lamnhan.com/testea/terminology.html"
                >Terminology</a
              >
            </li>
            <li>
              <a href="https://lamnhan.com/testea/installation.html"
                >Installation</a
              >
            </li>
            <li>
              <a href="https://lamnhan.com/testea/overview.html"
                >API Overview</a
              >
            </li>
            <li>
              <a href="https://lamnhan.com/testea/mocking.html">Mocking</a>
            </li>
            <li>
              <a class="active" href="https://lamnhan.com/testea/rewiring.html"
                >Rewiring</a
              >
            </li>
            <li>
              <a href="https://lamnhan.com/testea/stubbing.html">Stubbing</a>
            </li>
            <li>
              <a href="https://lamnhan.com/testea/the-cli.html">The CLI</a>
            </li>
          </ul>
        </aside>

        <article class="col-9 content">
          <div class="title"><h1>Rewiring</h1></div>

          <section
            id="toc"
            data-note="AUTO-GENERATED CONTENT, DO NOT EDIT DIRECTLY!"
          >
            <ul>
              <li>
                <a href="#-rewiremock"><code>rewiremock</code></a>
              </li>
              <li>
                <a
                  href="#-rewiremodule-input-mockedmodules-https-lamnhan-com-testea-index-html-rewiremodule"
                  ><a href="https://lamnhan.com/testea/index.html#rewiremodule"
                    ><code>rewireModule(input, mockedModules)</code></a
                  ></a
                >
                <ul>
                  <li>
                    <a
                      href="#the-modulerewiring-https-lamnhan-com-testea-classes-modulerewiring-html"
                      >The
                      <a
                        href="https://lamnhan.com/testea/classes/modulerewiring.html"
                        ><code>ModuleRewiring</code></a
                      ></a
                    >
                  </li>
                </ul>
              </li>
              <li>
                <a
                  href="#-rewireservice-serviceconstructor-mockedservices-withstubs-https-lamnhan-com-testea-index-html-rewireservice"
                  ><a href="https://lamnhan.com/testea/index.html#rewireservice"
                    ><code
                      >rewireService(serviceConstructor, mockedServices,
                      withStubs)</code
                    ></a
                  ></a
                >
                <ul>
                  <li>
                    <a
                      href="#the-servicerewiring-https-lamnhan-com-testea-classes-servicerewiring-html"
                      >The
                      <a
                        href="https://lamnhan.com/testea/classes/servicerewiring.html"
                        ><code>ServiceRewiring</code></a
                      ></a
                    >
                  </li>
                </ul>
              </li>
              <li>
                <a
                  href="#-rewirefull-input-mockedmodules-serviceinterface-mockedservices-withstubs-https-lamnhan-com-testea-index-html-rewirefull"
                  ><a href="https://lamnhan.com/testea/index.html#rewirefull"
                    ><code
                      >rewireFull(input, mockedModules, serviceInterface,
                      mockedServices, withStubs)</code
                    ></a
                  ></a
                >
                <ul>
                  <li>
                    <a
                      href="#the-fullrewiring-https-lamnhan-com-testea-classes-fullrewiring-html"
                      >The
                      <a
                        href="https://lamnhan.com/testea/classes/fullrewiring.html"
                        ><code>FullRewiring</code></a
                      ></a
                    >
                  </li>
                </ul>
              </li>
              <li>
                <a href="#rewiring-examples">Rewiring examples</a>
                <ul>
                  <li><a href="#rewire-module">Rewire module</a></li>
                  <li><a href="#rewire-service">Rewire service</a></li>
                </ul>
              </li>
              <li><a href="#fully-rewiring">Fully rewiring</a></li>
            </ul>
          </section>

          <section
            id="content"
            data-note="AUTO-GENERATED CONTENT, DO NOT EDIT DIRECTLY!"
          >
            <p>Load modules or services with mocked dependencies.</p>
            <p>
              A rewiring dependency is resolved by an <code>ID</code>, depending
              on the kind of a module:
            </p>
            <ul>
              <li>
                <strong>Native</strong>: the <code>id</code> is the same as the
                <code>name</code>: <code>path</code>, <code>os</code>, ...
              </li>
              <li>
                <strong>Installed</strong>: the <code>id</code> is the
                dependency name prefixed by a <code>~</code>:
                <ul>
                  <li>
                    <code>~lodash</code> -&gt;
                    <strong>./node_modules/lodash</strong>
                  </li>
                  <li>
                    <code>~@xxx/abc</code> -&gt;
                    <strong>./node_modules/xxx/abc</strong>
                  </li>
                </ul>
              </li>
              <li>
                <strong>Local</strong>: the <code>id</code> is prefixed by a
                <code>@</code>:
                <ul>
                  <li>
                    <code>@src/xxx/abc</code> -&gt;
                    <strong>./src/xxx/abc</strong>
                  </li>
                  <li>
                    Or <code>@xxx/abc</code> -&gt;
                    <strong>./src/xxx/abc</strong>
                  </li>
                </ul>
              </li>
            </ul>
            <h2 id="rewiremock"><code>rewiremock</code></h2>
            <p>
              This package also exports a
              <a href="https://github.com/theKashey/rewiremock"
                ><code>rewiremock</code></a
              >
              instance, so that you may rewire modules with the official
              interface. See more at:
              <a href="https://github.com/theKashey/rewiremock"
                >https://github.com/theKashey/rewiremock</a
              >
            </p>
            <h2 id="rewiremoduleinput-mockedmodules">
              <a href="https://lamnhan.com/testea/index.html#rewiremodule"
                ><code>rewireModule(input, mockedModules)</code></a
              >
            </h2>
            <p>Load a module with mocked dependencies.</p>
            <pre><code class="language-ts">// rewire the &#39;module1&#39;
const module1Rewiring = rewireModule(
  // load the original module
  &quot;@src/module1&quot;,
  // (optional) replace dependencies with mocked instances
  {
    path: {},
    &quot;~lodash&quot;: {},
    &quot;@xxx/abc&quot;: {},
  }
);

// start test
it(&quot;ok&quot;, async () =&gt; {
  // retrieve the rewired module
  const rewiredModule1 = await module1Rewiring.getModule();

  // test a method
  const result = rewiredModule1.someMethod();
  expect(result).equal(&quot;xxx&quot;);
});</code></pre>
            <h3 id="the-modulerewiring">
              The
              <a href="https://lamnhan.com/testea/classes/modulerewiring.html"
                ><code>ModuleRewiring</code></a
              >
            </h3>
            <p>
              <a href="https://lamnhan.com/testea/classes/modulerewiring.html"
                ><code>ModuleRewiring</code></a
              >
              is the constructor of <code>rewireModule</code>, see
              <code>rewireModule</code> for the list of parameters.
            </p>
            <table class="table">
              <thead>
                <tr>
                  <th>Method</th>
                  <th>Returns type</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>getModule()</code></td>
                  <td><code>Promise&lt;object&gt;</code></td>
                  <td>Get the rewired module</td>
                </tr>
                <tr>
                  <td><code>getService(name)</code></td>
                  <td><code>Promise&lt;class&gt;</code></td>
                  <td>Get a service constructor of the mocked module</td>
                </tr>
                <tr>
                  <td><code>getMockedModules()</code></td>
                  <td><code>object</code></td>
                  <td>Get all mocked dependencies</td>
                </tr>
                <tr>
                  <td><code>getResult()</code></td>
                  <td><code>Promise&lt;object&gt;</code></td>
                  <td>Get all data</td>
                </tr>
              </tbody>
            </table>
            <h2 id="rewireserviceserviceconstructor-mockedservices-withstubs">
              <a href="https://lamnhan.com/testea/index.html#rewireservice"
                ><code
                  >rewireService(serviceConstructor, mockedServices,
                  withStubs)</code
                ></a
              >
            </h2>
            <p>Load a service with mocked dependencies and stubing methods.</p>
            <pre><code class="language-ts">import { MyService } from &quot;module1&quot;;

const myServiceRewiring = rewireService(
  // the original or a mocked service constructor extracted from a rewired module
  MyService,
  // (optional) mocked service dependencies (constructor params)
  {
    &quot;@xxx/abc&quot;: {},
    &quot;@xxx/xyz&quot;: {},
  },
  // (optional) pre-stubing methods
  {
    a: 1,
    b: () =&gt; 2,
  }
);

// start test
it(&quot;ok&quot;, async () =&gt; {
  // retrieve the rewired service
  const rewiredMyService = await myServiceRewiring.getInstance();

  // test a method
  const result = rewiredMyService.someMethod();
  expect(result).equal(&quot;xxx&quot;);
});</code></pre>
            <h3 id="the-servicerewiring">
              The
              <a href="https://lamnhan.com/testea/classes/servicerewiring.html"
                ><code>ServiceRewiring</code></a
              >
            </h3>
            <p>
              <a href="https://lamnhan.com/testea/classes/servicerewiring.html"
                ><code>ServiceRewiring</code></a
              >
              is the constructor of <code>rewireService</code>, see
              <code>rewireService</code> for the list of parameters.
            </p>
            <table class="table">
              <thead>
                <tr>
                  <th>Method</th>
                  <th>Returns type</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>getInstance()</code></td>
                  <td><code>object</code></td>
                  <td>Get a instance of the rewired service</td>
                </tr>
                <tr>
                  <td><code>getStubbedInstance()</code></td>
                  <td>
                    <a href="#the-mockbuilder"><code>MockBuilder</code></a>
                  </td>
                  <td>Get the stubbing result</td>
                </tr>
                <tr>
                  <td><code>getMockedServices()</code></td>
                  <td><code>object</code></td>
                  <td>Get all mocked dependencies</td>
                </tr>
                <tr>
                  <td><code>stub(method)</code></td>
                  <td>
                    <a href="https://sinonjs.org/releases/latest/stubs/"
                      ><code>sinon.SinonStub</code></a
                    >
                  </td>
                  <td>Stub a method of the service</td>
                </tr>
                <tr>
                  <td><code>getName()</code></td>
                  <td><code>string</code></td>
                  <td>Get the name of the service</td>
                </tr>
                <tr>
                  <td><code>getResult()</code></td>
                  <td><code>object</code></td>
                  <td>Get all data</td>
                </tr>
              </tbody>
            </table>
            <h2
              id="rewirefullinput-mockedmodules-serviceinterface-mockedservices-withstubs"
            >
              <a href="https://lamnhan.com/testea/index.html#rewirefull"
                ><code
                  >rewireFull(input, mockedModules, serviceInterface,
                  mockedServices, withStubs)</code
                ></a
              >
            </h2>
            <p>Rewire both module &amp; service.</p>
            <h3 id="the-fullrewiring">
              The
              <a href="https://lamnhan.com/testea/classes/fullrewiring.html"
                ><code>FullRewiring</code></a
              >
            </h3>
            <p>
              A
              <a href="https://lamnhan.com/testea/classes/fullrewiring.html"
                ><code>FullRewiring</code></a
              >
              instance provides properties/methods to retrieve data for testea.
            </p>
            <table class="table">
              <thead>
                <tr>
                  <th>method</th>
                  <th>Returns type</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>rewireModule()</code></td>
                  <td>
                    <a href="#the-modulerewiring"
                      ><code>ModuleRewiring</code></a
                    >
                  </td>
                  <td>The module rewiring instance</td>
                </tr>
                <tr>
                  <td><code>rewireService()</code></td>
                  <td>
                    <a href="#the-servicerewiring"
                      ><code>Promise&lt;ServiceRewiring&gt;</code></a
                    >
                  </td>
                  <td>The service rewiring instance</td>
                </tr>
                <tr>
                  <td><code>getResult()</code></td>
                  <td><code>Promise&lt;object&gt;</code></td>
                  <td>Get all data</td>
                </tr>
              </tbody>
            </table>
            <h2 id="rewiring-examples">Rewiring examples</h2>
            <p>
              All testea examples is using
              <a href="https://mochajs.org/">mocha</a> as test runner and
              <a href="https://www.chaijs.com/">chai</a> as assertion tool.
            </p>
            <h3 id="rewire-module">Rewire module</h3>
            <p>An example of how to rewire a module.</p>
            <p>
              <strong><code>./src/module1.ts</code></strong>
            </p>
            <pre><code class="language-ts">import { resolve } from &quot;path&quot;;

export function doSomething() {
  const useExternal = resolve(&quot;xxx&quot;);
  return &quot;something&quot;;
}</code></pre>
            <p>
              <strong><code>./test/module1.spec.ts</code></strong>
            </p>
            <pre><code class="language-ts">import { rewireModule } from &quot;@lamnhan/testea&quot;;

// setup
function getModule() {
  return rewireModule(
    // load the tested module
    &quot;@src/module1&quot;,
    // rewire all dependencies with mocked replacement
    {
      path: {
        resolve: () =&gt; &quot;any mocked returns value&quot;,
        // mock other methods of this module
      },
    }
  );
}

// start testea
describe(&quot;Test module1&quot;, () =&gt; {
  it(&quot;#doSomething&quot;, async () =&gt; {
    // retrieve the rewired module
    const module1Rewiring = getModule();
    const rewiredModule1 = await module1Rewiring.getModule();

    // test a module member
    const result = rewiredModule1.doSomething();
    expect(result).equal(&quot;xxx&quot;);
  });
});</code></pre>
            <h3 id="rewire-service">Rewire service</h3>
            <p>An example of how to rewire a service.</p>
            <p>
              <strong><code>./src/module1.ts</code></strong>
            </p>
            <pre><code class="language-ts">export class Service1 {
  constructor() {}

  doSomething(param1: any) {
    // do something with the &#39;param1&#39;
    return &quot;something&quot;;
  }
}</code></pre>
            <p>
              <strong><code>./src/module2.ts</code></strong>
            </p>
            <pre><code class="language-ts">import { Service1 } from &quot;./module1&quot;;

export class Service2 {
  private service1: Service1;

  constructor(service1: Service1) {
    this.service1 = service1;
  }

  doSomething() {
    const useExternal = this.service1.doSomething(&quot;xxx&quot;);
    return &quot;something&quot;;
  }
}</code></pre>
            <p>
              <strong><code>./test/module2.spec.ts</code></strong>
            </p>
            <pre><code class="language-ts">import { rewireService } from &#39;@lamnhan/testea&#39;;

import { Service2 } from &#39;../src/module2&#39;;

// setup
function getService() {
  return rewireService(
    // rewire this service
    Service2,
    // replace all dependencies with mocked replacement
    {
      &#39;@src/module1&#39;: {
        doSomething1: &#39;any mocked returns value&#39;;
      },
    },
    // no stubbing for now
  );
}

// start testea
describe(&#39;Test Service2&#39;, () =&gt; {

  it(&#39;#doSomething2&#39;, async () =&gt; {
    // retrieve the rewired service
    const service2Rewiring = getService();
    const rewiredService2 = await service2Rewiring.getInstance();
    // retrieve a mocked servics for passed argument testea
    const { &#39;@src/module1&#39;: mockedModule1 } = service2Rewiring.getMockedServices();

    // test a module member
    const result = rewiredService2.doSomething();
    expect(result).equal(&#39;...&#39;);
    expect(
      mockedModule1.getArgFirst(&#39;doSomething&#39;), // get the first arg of #doSomething
    ).equal(&#39;xxx&#39;);
  });

});</code></pre>
            <h2 id="fully-rewiring">Fully rewiring</h2>
            <p>
              An example of how to rewire a module and a service with full
              functionality.
            </p>
            <p>
              <strong><code>./src/module1.ts</code></strong>
            </p>
            <pre><code class="language-ts">import { resolve } from &quot;path&quot;;
import { readFile } from &quot;fs-extra&quot;;

import { Service2 } from &quot;./service2&quot;;

export class MyService {
  private service2: Service2;

  constructor(service2: Service2) {
    this.service2 = service2;
  }

  doSomething() {
    const usePath = resolve(&quot;xxx&quot;);
    const useFSExtra = readFile(&quot;xxx.txt&quot;);
    const useService2 = this.service2.doSomething(&quot;xxx&quot;);
    return &quot;something&quot;;
  }

  doMore() {
    const useThis = this.doSomething();
    return &quot;do more&quot;;
  }
}</code></pre>
            <p>
              <strong><code>./test/module1.spec.ts</code></strong>
            </p>
            <pre><code class="language-ts">import { rewireFull } from &#39;@lamnhan/testea&#39;;

import { MyService } from &#39;../src/module1&#39;;

// setup test
async function setup(
  stubs: any,
) {
  return rewireFull(
    // load the tested module
    &#39;@src/module1&#39;, // () =&gt; import(&#39;../src/module1&#39;)
    // rewire all dependencies with mocked replacement
    {
      &#39;path&#39;: {
        resolve: () =&gt; &#39;any mocked returns value&#39;,
        // mock other methods of this module
      },
      &#39;~fs-extra&#39;: {
        readFile: async () =&gt; &#39;any mocked returns value&#39;,
        // mock other methods of this module
      }
    }
    // rewire this service
    MyService,
    // replace all dependencies with mocked replacement
    {
      &#39;@src/service2&#39;: {
        doSomething: &#39;any mocked returns value&#39;;
      },
    },
    stubs,
  )
  .getResult();
}

// start testea
describe(&#39;Test MyService&#39;, () =&gt; {

  it(&#39;#doSomething&#39;, async () =&gt; {
    // retrieve the data
    const {
      service,
      mockedModules: {
        &#39;path&#39;: mockedPathModuleTestea,
        &#39;~fs-extra&#39;: mockedFSExtraModuleTestea,
      },
      mockedServices: {
        &#39;@src/service2&#39;: mockedService2Testea,
      }
    } = await setup();

    // test a service method
    const result = service.doSomething();
    expect(result).equal(&#39;...&#39;);
    // do more assertions about passed arguments
    const resolveArgs = mockedPathModuleTestea.getArgFirst(&#39;resolve&#39;);
    const readFileArg = mockedFSExtraModuleTestea.getArgFirst(&#39;readFile&#39;);
    const doSomethingArg = mockedService2Testea.getArgFirst(&#39;doSomething&#39;);
    expect(resolveArg).equal(&#39;xxx&#39;);
    expect(readFileArg).equal(&#39;xxx.txt&#39;);
    expect(doSomethingArg).equal(&#39;xxx&#39;);
    // ...
  });

  it(&#39;#doMore&#39;, async () =&gt; {
    // retrieve the data
    const { service } = await setup({
      doSomething: &#39;returns something else&#39;,
    });

    // test a service method
    const result = service.doMore();
    expect(result).equal(&#39;...&#39;);
  });

});</code></pre>
          </section>
        </article>
      </div>
    </div>

    <div class="container-fluid footer">
      <div class="row">
        <div class="col-12">
          <p>
            ⚡️ This document is generated automatically using
            <a href="https://github.com/lamnhan/ayedocs" target="_blank"
              >@lamnhan/ayedocs</a
            >.
          </p>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-css-extras.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-powershell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-json.min.js"></script>
  </body>
</html>
